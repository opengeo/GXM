<!DOCTYPE html>
<html>
    <head>
        <title>Map.test.html</title>
        <link rel="stylesheet" href="http://cdn.sencha.io/touch/sencha-touch-2.0.1/resources/css/sencha-touch.css" type="text/css">
        <link rel="stylesheet" href="../../../resources/css/gxm.css" type="text/css">
        
        <script type="text/javascript" src="http://cdn.sencha.io/touch/sencha-touch-2.0.1/sencha-touch-all-debug.js"></script>
        <script type="text/javascript" src="http://openlayers.org/api/2.12-rc7/OpenLayers.js"></script>

        <script type="text/javascript">
Ext.Loader.setConfig({
        disableCaching: false,
        enabled: true,
        paths: {
            //Ext: "<PATH_TO_EXT_JS>/src",
            GXM: '../../../lib/GXM'
        }
    });

    Ext.require([
        'GXM.Map',
        'Ext.Logger'
    ]);
    </script>
        <script type="text/javascript" src="../../helperfunctions.js"></script>     
        

        <script type="text/javascript">
       
        function createMap() {
            var map = new OpenLayers.Map();
            var layer = new OpenLayers.Layer("test", {isBaseLayer: true});
            map.addLayer(layer);
            // add a vector layer, which would fail onmapresize if we render
            // the map before the panel has a layout.
            map.addLayer(new OpenLayers.Layer.Vector("vector layer"));
            return map;
        }

        function test_mappanel(t) {
            t.plan(3)

            var moveToCnt;

            var map = createMap();
            map.moveTo = function() {
                moveToCnt++;
                OpenLayers.Map.prototype.moveTo.apply(this, arguments);
            };

            moveToCnt = 0;
            var mapPanel = Ext.create('GXM.Map', {
                // panel options
                id: "map-panel",
                title: "GXM MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                // map panel-specific options
                map: map,
                center: new OpenLayers.LonLat(5, 45),
                zoom: 4
            });
            t.eq(moveToCnt, 2, "map.moveTo called exactly twice");
            t.eq(mapPanel.getMap().getCenter().toString(), "lon=5,lat=45", "Map center set correctly");
            t.eq(mapPanel.getMap().getZoom(), 4, "Zoom set correctly");
            // since we created the map, we destroy it
            map.destroy();
            
            mapPanel.destroy();
        }
        
        function test_allOverlays(t) {
            t.plan(3);

            var map, panel;
            
            map = new OpenLayers.Map();
            panel = Ext.create('GXM.Map', {
                map: map
            });
            t.eq(panel.getMap().allOverlays, false, "allOverlays is not set if map is provided to panel");
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();
            
            panel = Ext.create('GXM.Map', {
            });
            t.eq(panel.getMap().allOverlays, true, "allOverlays set to true if no map is provided to panel");
            panel.destroy();
            
            panel = Ext.create('GXM.Map', {
                map: {
                    units: "meters"
                }
            });
            t.eq(panel.getMap().allOverlays, true, "allOverlays set to true if map config is provided to panel");
            panel.destroy();
        }

        function test_zoom(t) {
            t.plan(1);

            var panel = Ext.create('GXM.Map', {
                title: "GXM MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                layers: [new OpenLayers.Layer()],
                zoom: 4
            });
            
            t.eq(panel.getMap().getZoom(), 4, "zoom correctly set");
            
            panel.destroy();
        }

        function test_extent(t) {
            t.plan(4);

            var map, panel, log = {};
            
            map = createMap();
            map.zoomToExtent = function(extent) {
                log.extent = extent;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                extent: [1, 2, 3, 4]
            });            
            t.eq(log.extent.toArray(), [1, 2, 3, 4], "map extent set with array");
            delete log.extent;
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();
            
            map = createMap();
            map.zoomToExtent = function(extent) {
                log.extent = extent;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                extent: "1, 2, 3, 4"
            });
            t.eq(log.extent.toArray(), [1, 2, 3, 4], "map extent set with string");
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();
            
            map = createMap();
            map.zoomToExtent = function(extent) {
                log.extent = extent;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                extent: new OpenLayers.Bounds(1, 2, 3, 4)
            });
            t.eq(log.extent.toArray(), [1, 2, 3, 4], "map extent set with Bounds");
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();
            
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: createMap(), //TODO: revisit the mappanel tests, to check 
                                  // why we need map here
                height: 400,
                width: 600,
                extent: new OpenLayers.Bounds(1, 2, 3, 4)
            });
            panel.getMap().addLayer(new OpenLayers.Layer());
            t.ok(panel.getMap().getExtent(), "map has an extent after layer is added");
            panel.destroy();
        }
        
        function test_center(t) {
            t.plan(3);

            var map, panel, log = {};
            
            map = createMap();
            map.setCenter = function(center) {
                log.center = center;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                center: [1, 2]
            });            
            t.eq(log.center.toString(), "lon=1,lat=2", "map center set with array");
            delete log.center;
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();

            map = createMap();
            map.setCenter = function(center) {
                log.center = center;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                center: "1, 2"
            });            
            t.eq(log.center.toString(), "lon=1,lat=2", "map center set with string");
            delete log.center;
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();

            map = createMap();
            map.setCenter = function(center) {
                log.center = center;
            };
            panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                center: new OpenLayers.LonLat(1, 2)
            });            
            t.eq(log.center.toString(), "lon=1,lat=2", "map center set with LonLat");
            delete log.center;
            // since we created the map, we destroy it
            map.destroy();
            panel.destroy();
        }
        
        function test_destroy(t) {
            
            /**
             * If the panel is passed an instance of OpenLayers.Map, we don't
             * touch it in the destroy sequence, we only remove our reference
             * to it.  If the panel is passed a map config object, the panel
             * creates the OpenLayers.Map instance, and the panel destroys the
             * map in its destroy sequence.
             */

            t.plan(3);
            
            var panel = Ext.create('GXM.Map', {
                renderTo: "mappanel",
                layers: [
                    new OpenLayers.Layer("test")
                ],
                zoom: 1
            });
            
            t.ok(panel.getMap() instanceof OpenLayers.Map, "panel creates a map");
            
            var called = false;
            panel.getMap().destroy = function() {
                called = true;
                OpenLayers.Map.prototype.destroy.apply(panel.getMap(), arguments);
            }
            try {
                panel.destroy();
                t.ok(called, "panel.destroy calls map.destroy");
            } catch(err) {
                t.fail("panel.destroy causes problems: " + err);
            }
            t.ok(!panel.getMap(), "panel has no reference to a map");
        }
       
    </script>
  </head>
  <body>
    <div id="mappanel"></div>
  </body>
</html>
